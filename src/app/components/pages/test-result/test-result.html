<form [formGroup]="filterForm" class="filter-form global-filter">
  <label>
    Студент от:
    <input
      type="number"
      formControlName="from"
      inputmode="numeric"
      (keydown)="preventNonNumeric($event)"
    />
  </label>
  <label>
    до:
    <input
      type="number"
      formControlName="to"
      inputmode="numeric"
      (keydown)="preventNonNumeric($event)"
    />
  </label>

  <div class="error-messages" *ngIf="filterForm.errors?.['rangeInvalid']">
    Значение "до" должно быть больше или равно "от"
  </div>

  <div
    class="error-messages"
    *ngIf="filterForm.get('from')?.invalid && filterForm.get('from')?.touched"
  >
    <span *ngIf="filterForm.get('from')?.errors?.['required']"
      >Обязательное поле</span
    >
    <span *ngIf="filterForm.get('from')?.errors?.['min']"
      >Минимальное значение 1</span
    >
    <span *ngIf="filterForm.get('from')?.errors?.['pattern']"
      >Только цифры</span
    >
  </div>

  <div
    class="error-messages"
    *ngIf="filterForm.get('to')?.invalid && filterForm.get('to')?.touched"
  >
    <span *ngIf="filterForm.get('to')?.errors?.['required']"
      >Обязательное поле</span
    >
    <span *ngIf="filterForm.get('to')?.errors?.['min']"
      >Минимальное значение 1</span
    >
    <span *ngIf="filterForm.get('to')?.errors?.['pattern']">Только цифры</span>
  </div>
</form>

<!-- Вкладки -->
<div class="tabs">
  <button [class.active]="activeTab === 'all'" (click)="setActiveTab('all')">
    Все
  </button>
  <button
    [class.active]="activeTab === 'students'"
    (click)="setActiveTab('students')"
  >
    Студенты
  </button>
  <button
    [class.active]="activeTab === 'skills'"
    (click)="setActiveTab('skills')"
  >
    Навыки
  </button>
  <button
    [class.active]="activeTab === 'disciplines'"
    (click)="setActiveTab('disciplines')"
  >
    Дисциплины
  </button>
</div>

<!-- Вкладка "Все результаты" -->
<div id="all-tab" *ngIf="activeTab === 'all'" class="tab-panel">
  <table *ngIf="!isLoading && filteredResults.length" class="results-table">
    <thead>
      <tr>
        <th (click)="sortBy('sessionName')" *ngIf="!sessionId">Сессия</th>
        <th (click)="sortBy('disciplineName')">Дисциплина</th>
        <th (click)="sortBy('skillName')">Навык</th>
        <th (click)="sortBy('studentId')">Студент</th>
        <th (click)="sortBy('teacherName')">Преподаватель</th>
        <th (click)="sortBy('score')">Результат</th>
        <th (click)="sortBy('resultDate')">Дата</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let r of filteredResults">
        <td *ngIf="!sessionId">{{ r.sessionName }}</td>
        <td>{{ r.disciplineName }}</td>
        <td>{{ r.skillName }}</td>
        <td>{{ r.studentId }}</td>
        <td>{{ r.teacherName }}</td>
        <td>{{ r.score }}%</td>
        <td>{{ r.resultDate | date : "dd.MM.yyyy" }}</td>
      </tr>
    </tbody>
  </table>
  <div *ngIf="!isLoading && filteredResults.length === 0" class="empty">
    Нет результатов
  </div>
</div>

<!-- Вкладка "Студенты" -->
<div *ngIf="activeTab === 'students'" class="tab-panel">
  <div class="card">
    <h3>Сравнительная таблица студентов</h3>
    <table class="results-table">
      <thead>
        <tr>
          <th>Навык</th>
          <th *ngFor="let s of filteredStudents">{{ s }}</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let skill of uniqueSkills">
          <td class="skill-name">{{ skill }}</td>
          <td *ngFor="let s of filteredStudents">
            {{
              getScoreForStudentSkill(s, skill) !== null
                ? getScoreForStudentSkill(s, skill) + "%"
                : "-"
            }}
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Вкладка "Навыки" -->
<div *ngIf="activeTab === 'skills'" class="tab-panel">
  <div class="skill-list">
    <div
      *ngFor="let skill of uniqueSkills"
      class="skill-item card"
      [class.active]="selectedSkill === skill"
      (click)="selectedSkill = skill"
    >
      <span class="name">{{ skill }}</span>
      <span class="avg">Средний: {{ getAverageScoreForSkill(skill) }}%</span>
    </div>
  </div>

  <div *ngIf="selectedSkill" class="card">
    <h3>Результаты по навыку {{ selectedSkill }}</h3>
    <table class="results-table">
      <thead>
        <tr>
          <th>Студент</th>
          <th>Результат</th>
          <th>Дата</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let r of getResultsForSelectedSkill()">
          <td>{{ r.studentId }}</td>
          <td>{{ r.score }}%</td>
          <td>{{ r.resultDate | date : "dd.MM.yyyy" }}</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Вкладка "Дисциплины" -->
<div *ngIf="activeTab === 'disciplines'" class="tab-panel">
  <div class="discipline-list">
    <div *ngFor="let d of uniqueDisciplines" class="discipline-item card">
      <span class="name">{{ d }}</span>
      <span class="avg">Средний: {{ getAverageScoreForDiscipline(d) }}%</span>
    </div>
  </div>
</div>
