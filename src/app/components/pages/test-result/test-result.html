<!-- Фильтр по диапазону студентов -->
<form [formGroup]="filterForm" class="filter-form global-filter">
  <label>
    Студент от:
    <input
      type="number"
      formControlName="from"
      (keydown)="preventNonNumeric($event)"
    />
  </label>
  <label>
    до:
    <input
      type="number"
      formControlName="to"
      (keydown)="preventNonNumeric($event)"
    />
  </label>

  <div class="error-messages" *ngIf="filterForm.errors?.['rangeInvalid']">
    Значение "до" должно быть больше или равно "от"
  </div>

  <div class="error-messages" *ngFor="let field of ['from', 'to']">
    <ng-container
      *ngIf="filterForm.get(field)?.invalid && filterForm.get(field)?.touched"
    >
      <span *ngIf="filterForm.get(field)?.errors?.['required']"
        >Обязательное поле</span
      >
      <span *ngIf="filterForm.get(field)?.errors?.['min']"
        >Минимальное значение 1</span
      >
      <span *ngIf="filterForm.get(field)?.errors?.['pattern']"
        >Только цифры</span
      >
    </ng-container>
  </div>
</form>

<!-- Вкладки -->
<div class="tabs">
  <button [class.active]="activeTab === 'all'" (click)="setActiveTab('all')">
    Все
  </button>
  <button
    [class.active]="activeTab === 'students'"
    (click)="setActiveTab('students')"
  >
    Студенты
  </button>
  <button
    [class.active]="activeTab === 'skills'"
    (click)="setActiveTab('skills')"
  >
    Навыки
  </button>
  <button
    [class.active]="activeTab === 'disciplines'"
    (click)="setActiveTab('disciplines')"
  >
    Дисциплины
  </button>
</div>

<!-- Вкладки контент -->
<div class="tab-panel" *ngIf="activeTab === 'all'">
  <ng-container *ngIf="!isLoading && filteredResults.length; else noResults">
    <table class="results-table">
      <thead>
        <tr>
          <th *ngIf="!sessionId" (click)="sortBy('sessionName')">Сессия</th>
          <th (click)="sortBy('disciplineName')">Дисциплина</th>
          <th (click)="sortBy('skillName')">Навык</th>
          <th (click)="sortBy('studentId')">Студент</th>
          <th (click)="sortBy('teacherName')">Преподаватель</th>
          <th (click)="sortBy('score')">Результат</th>
          <th (click)="sortBy('resultDate')">Дата</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let r of filteredResults">
          <td *ngIf="!sessionId">{{ r.sessionName }}</td>
          <td>{{ r.disciplineName }}</td>
          <td>{{ r.skillName }}</td>
          <td>{{ r.studentId }}</td>
          <td>{{ r.teacherName }}</td>
          <td>{{ r.score }}%</td>
          <td>{{ r.resultDate | date : "dd.MM.yyyy" }}</td>
        </tr>
      </tbody>
    </table>
  </ng-container>
  <ng-template #noResults>
    <div class="empty">Нет результатов</div>
  </ng-template>
</div>

<!-- Студенты -->
<div class="tab-panel" *ngIf="activeTab === 'students'">
  <div class="card">
    <h3>Сравнительная таблица студентов</h3>
    <table class="results-table">
      <thead>
        <tr>
          <th>Навык</th>
          <th *ngFor="let s of filteredStudents">{{ s }}</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let skill of uniqueSkills">
          <td class="skill-name">{{ skill }}</td>
          <td *ngFor="let s of filteredStudents">
            {{
              getScoreForStudentSkill(s, skill) !== null
                ? getScoreForStudentSkill(s, skill) + "%"
                : "-"
            }}
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Навыки -->
<div class="tab-panel" *ngIf="activeTab === 'skills'">
  <div class="item-list">
    <div
      *ngFor="let skill of uniqueSkills"
      class="item-card"
      [class.active]="selectedSkill === skill"
      (click)="selectedSkill = skill"
    >
      <span class="name">{{ skill }}</span>
      <span class="avg">Средний: {{ getAverageScoreForSkill(skill) }}%</span>
    </div>
  </div>

  <div *ngIf="selectedSkill" class="card">
    <h3>Результаты по навыку {{ selectedSkill }}</h3>
    <table class="results-table">
      <thead>
        <tr>
          <th>Студент</th>
          <th>Результат</th>
          <th>Дата</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let r of getResultsForSelectedSkill()">
          <td>{{ r.studentId }}</td>
          <td>{{ r.score }}%</td>
          <td>{{ r.resultDate | date : "dd.MM.yyyy" }}</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Дисциплины -->
<div class="tab-panel" *ngIf="activeTab === 'disciplines'">
  <div class="item-list">
    <div *ngFor="let d of uniqueDisciplines" class="item-card">
      <span class="name">{{ d }}</span>
      <span class="avg">Средний: {{ getAverageScoreForDiscipline(d) }}%</span>
    </div>
  </div>
</div>
